<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>本地视觉-语言大模型部署和使用</title>
    <style>
        /* 固定右下角按钮 */
        #liveToastBtn {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        font-size: 2rem;
        cursor: pointer;
        z-index: 1055; /* 高于 toast 默认 z-index */
        border: none;
        background: none;
        color: #0d6efd; /* Bootstrap primary color */
        }
    </style>
  </head>
  <body>
    <h1 id="blog_title" class="lh-lg">
        怎么部署本地大模型
    </h1>
    本文基于通义千问3-0.6B大模型，但是在8B，14B和32B大模型中都测试通过。
    <h1 id="setup_env" class="lh-lg">
        环境配置
    </h1>
    <h2 id="create_conda" class="lh-sm">创建conda环境</h2>
    <p>
        首先，创建conda环境，使用<code>python=3.10.19</code>
    </p>
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-cmd">
conda create -n qwen_vl python=3.10.19 -y
conda activate qwen_vl
        </code></pre>
    </div>


    <h2 id="install_torch">安装Pytorch</h2>
    <p>
        在实验中，我们使用pytorch2.8，需要注意你的系统版本是否太老旧，没有办法使用这个pytorch的版本。
    </p>
    <!-- 安装pytorch的命令 -->
    <p>
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#LinuxWindows_cmd" aria-expanded="false" aria-controls="LinuxWindows_cmd">
            Linux&Windows安装命令
        </button>
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#Mac_cmd" aria-expanded="false" aria-controls="Mac_cmd">
            MacOS安装命令
        </button>
    </p>

    <div class="collapse show" id="LinuxWindows_cmd">
        <div class="card card-body">
            <div class="position-relative border rounded p-3 bg-light">
                <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
                <pre class="mb-0"><code class="language-cmd">
pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0 --index-url https://download.pytorch.org/whl/cu129
                </code></pre>
            </div>
        </div>
    </div>
    <div class="collapse" id="Mac_cmd">
        <div class="card card-body">
            <div class="position-relative border rounded p-3 bg-light">
                <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
                <pre class="mb-0"><code class="language-cmd">
pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0
                </code></pre>
            </div>
        </div>
    </div>

    <!-- <h2 id="install_vllm" class="lh-sm">安装vllm</h2> -->
    <!-- <div class="alert alert-danger" role="alert">
        Windows用户无法使用vllm，但是可以继续往后看，可以单独使用大模型推理，只是不能使用vllm的功能。
    </div>
    vllm是一个大模型推理的服务库。安装使用命令：
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-cmd">
pip install vllm==0.11.0
        </code></pre>
    </div> -->

    <h2 id="install_modelscope" class="lh-sm">下载Modelscope</h2>
    <p>
        ModelScpde是阿里巴巴公司推出的大模型开放平台。使用下面命令安装:
    </p>
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-cmd">
pip install modelscope==1.32.0
        </code></pre>
    </div>

    <h2 id="install_others" class="lh-sm">下载其他包</h2>
    <p>
        还需要下载一些其他的包：
    </p>
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-bash">
pip install accelerate==1.11.0 
<!-- pip install triton==3.4.0
pip install asyncio==4.0.0 -->
        </code></pre>
        <div class="alert alert-danger" role="alert">
accelerate要求python>=3.10
        </div>
    </div>
    <p>
        注意检查transformers的版本，我们测试中使用4.57.3
    </p>
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-bash">
pip install transformers==4.57.3
        </code></pre>
    </div>

    <h1 id="install_model" class="lh-sm">下载大模型</h1>
    <h2 id="check_file" class="lh-sm">检查所有可用的模型文件</h2>
    <p>
        这个是官方网页的模型库的连接: 
        <a href="https://www.modelscope.cn/models" class="link-info" target="_blank">魔塔模型库</a>
    </p>
    <p>
        可以搜索，拿到搜索结果。
        但是它有一个问题，有时候你需要搜索<code>通义千问3</code>，有时候却需要搜索<code>Qwen3</code>。
    </p>

    <div id="Qwen3_search_res" class="carousel slide" data-bs-ride="false">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#Qwen3_search_res" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#Qwen3_search_res" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <!-- <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2" aria-label="Slide 3"></button> -->
        </div>
        <div class="carousel-inner">
            <!-- 通义千问搜索结果 -->
            <div class="carousel-item active">
                <img src="/static/img/blog/LLM_deploy_and_ft/3_llm_vl_deploy/search_res_zh.png" class="d-block w-100" alt="使用中文通义千问的搜索结果">
                <div class="carousel-caption d-none d-md-block">
                    <p class="text-info fs-1"></p>
                    <!-- <p class="text-info fs-1">使用中文通义千问的搜索结果</p> -->
                </div>
            </div>
            <!-- <div class="carousel-item">
                <img src="/static/img/blog/LLM_deploy_and_ft/1_llm_deploy/search_res_en.png" class="d-block w-100" alt="使用英文Qwen3的搜索结果">
                <div class="carousel-caption d-none d-md-block">
                    <p class="text-info fs-1">使用英文Qwen3的搜索结果</p>
                </div>
            </div> -->
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#Qwen3_search_res" data-bs-slide="prev">
            <i class="bi bi-chevron-left fs-2 text-primary"></i>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#Qwen3_search_res" data-bs-slide="next">
            <i class="bi bi-chevron-right fs-2 text-primary"></i>
        </button>
    </div>

    <h2 id="install_model_file" class="lh-sm">下载想要的模型</h2>
    <p>
        首先，我们在搜索界面，找到想要安装的大模型，点到详情页，复制下载名字：
    </p>
    <div id="Qwen3_detail_page" class="carousel slide" data-bs-ride="false">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#Qwen3_detail_page" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <!-- <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2" aria-label="Slide 3"></button> -->
        </div>
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="/static/img/blog/LLM_deploy_and_ft/3_llm_vl_deploy/detail_name.png" class="d-block w-100" alt="">
                <div class="carousel-caption d-none d-md-block">
                    <p class="text-info fs-1">黄色标记了需要复制的名字</p>
                </div>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#Qwen3_detail_page" data-bs-slide="prev">
            <i class="bi bi-chevron-left fs-2 text-primary"></i>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#Qwen3_detail_page" data-bs-slide="next">
            <i class="bi bi-chevron-right fs-2 text-primary"></i>
        </button>
    </div>
    <p>
        在我们激活的环境下，使用下面命令下载模型：
    </p>
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-cmd">
modelscope download --model Qwen/Qwen3-VL-2B-Instruct --local_dir PATH
        </code></pre>
    </div>
    <p>
        简易理解下，我们可以认为NB的模型需要2N的显存，如8B的模型需要16G的显存。具体下载多少B的模型，请根据自己的本地显存大小和算力选择。<code>--local_dir</code>手动指定下载的路径，不手动指定也可以，会有一个默认的路径。
    </p>

    <h1 id="load_and_use" class="lh-lg">
        加载并使用大模型
    </h1>
    <h2 id="construct_msg" class="lh-sm">构造消息</h2>
    <p>
        每一个发送的消息都应该类似于：
    </p>
    <div class="position-relative border rounded p-3 bg-light">
        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
        <pre class="mb-0"><code class="language-json">
messages = [
    {
        "role": "user",
        "content": [
            {
                "type": "image",
                "image": "图片路径，可以是url，可以是本地路径（相对路径或者绝对路径）",
            },
            {"type": "text", "text": "描述这个图片.（可以是中文，可以是英文）"},
        ],
    }
]

        </code></pre>
    </div>
    <div class="alert alert-warning" role="alert">
        role必须是user，不可以写成其他内容。
    </div>
    <h2 id="use" class="lh-sm">使用大模型</h2>
    <p>
        在模型详情页，往下翻，有一个官方的代码，
    </p>
    <!-- 展示代码 -->
    <div class="accordion" id="show_codes_code">
        <div class="accordion-item">
            <h2 class="accordion-header" id="official_code_head">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#official_code" aria-expanded="true" aria-controls="official_code">
                    官方代码
                </button>
            </h2>
            <div id="official_code" class="accordion-collapse collapse show" aria-labelledby="official_code">
                <div class="accordion-body">
                    <!-- 官方代码 -->
                    <div class="position-relative border rounded p-3 bg-light">
                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
                        <pre class="mb-0"><code class="language-python">
# -*- coding: utf-8
"""
使用千问的官方代码运行测试: https://www.modelscope.cn/models/Qwen/Qwen3-VL-2B-Instruct
"""
from modelscope import Qwen3VLForConditionalGeneration, AutoProcessor
# default: Load the model on the available device(s)
model = Qwen3VLForConditionalGeneration.from_pretrained(
    "Qwen/Qwen3-VL-2B-Instruct", dtype="auto", device_map="auto"
)
# We recommend enabling flash_attention_2 for better acceleration and memory saving, especially in multi-image and video scenarios.
# model = Qwen3VLForConditionalGeneration.from_pretrained(
#     "Qwen/Qwen3-VL-2B-Instruct",
#     dtype=torch.bfloat16,
#     attn_implementation="flash_attention_2",
#     device_map="auto",
# )
processor = AutoProcessor.from_pretrained("Qwen/Qwen3-VL-2B-Instruct")
messages = [
    {
        "role": "user",
        "content": [
            {
                "type": "image",
                "image": "https://qianwen-res.oss-cn-beijing.aliyuncs.com/Qwen-VL/assets/demo.jpeg",
            },
            {"type": "text", "text": "Describe this image."},
        ],
    }
]
# Preparation for inference
inputs = processor.apply_chat_template(
    messages,
    tokenize=True,
    add_generation_prompt=True,
    return_dict=True,
    return_tensors="pt"
)
inputs = inputs.to(model.device)
# Inference: Generation of the output
generated_ids = model.generate(**inputs, max_new_tokens=128)
generated_ids_trimmed = [
    out_ids[len(in_ids) :] for in_ids, out_ids in zip(inputs.input_ids, generated_ids)
]
output_text = processor.batch_decode(
    generated_ids_trimmed, skip_special_tokens=True, clean_up_tokenization_spaces=False
)
print(output_text)
                        </code></pre>
    <div class="alert alert-warning" role="alert">
        如果你没有修改模型下载路径，那么model_name就是你复制的那个名字，否则就是你的下载路径（绝对路径或者相对路径）
    </div>
    <div class="alert alert-warning" role="alert">
        Mac的M系列芯片用户，你需要删除<code>device_map="auto"</code>
    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header" id="code_output_head">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#code_output" aria-expanded="false" aria-controls="code_output">
                    代码的输出
                </button>
            </h2>
            <div id="code_output" class="accordion-collapse collapse" aria-labelledby="code_output_head">
                <div class="accordion-body">
                    <div class="position-relative border rounded p-3 bg-light">
                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2 copy-btn"><i class="bi bi-copy"></i></button>
                        <pre class="mb-0"><code class="language-python">
['This is a heartwarming photograph capturing a serene and joyful moment between a woman and her dog on a sandy beach during what appears to be the golden hour, either sunrise or sunset.\n\n- **The Subjects**: A woman and a large, light-colored Labrador Retriever are the central figures. The woman is sitting on the sand, turned towards the dog, with a warm, gentle smile on her face. The dog is sitting upright, facing the woman, and is extending its paw to give her a high-five. The dog is wearing a blue harness with a colorful paw print pattern.\n\n- **The Setting**: The scene is set on']
                        </code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                Accordion Item #3
                </button>
            </h2>
            <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingThree">
                <div class="accordion-body">
                <strong>This is the third item's accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
                </div>
            </div>
        </div> -->
    </div>

    <p>
        目前为止，大模型部署和简单使用都已经完成了。希望这个文档能帮助到你。
    </p>


    <!-- icon的按钮 -->
    <button type="button" class="btn btn-primary" id="liveToastBtn"><i class="bi bi-card-list"></i></button>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
        <!-- <img src="https://via.placeholder.com/20" class="rounded me-2" alt="..."> -->
        <strong class="me-auto">contents</strong>
        <!-- <small>11 mins ago</small> -->
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <nav id="navbar-example3" class="h-100 flex-column align-items-stretch pe-4 border-end">
                <nav class="nav nav-pills flex-column">
                    <a class="nav-link" href="#blog_title">本地大模型部署</a>
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link" href="#setup_env">环境配置</a>
                        <a class="nav-link ms-3 my-1" href="#create_conda">创建conda环境</a>
                        <a class="nav-link ms-3 my-1" href="#install_torch">安装Pytorch</a>
                        <a class="nav-link ms-3 my-1" href="#install_vllm">安装vllm</a>
                        <a class="nav-link ms-3 my-1" href="#install_modelscope">安装Modelscope</a>
                        <a class="nav-link ms-3 my-1" href="#install_others">下载其他包</a>
                    </nav>
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link" href="#install_model">下载大模型</a>
                        <a class="nav-link ms-3 my-1" href="#check_file">检查所有可用的模型文件</a>
                        <a class="nav-link ms-3 my-1" href="#install_model_file">下载想要的模型</a>
                    </nav>
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link" href="#load_and_use">加载并使用大模型</a>
                        <a class="nav-link ms-3 my-1" href="#construct_msg">构造消息</a>
                        <a class="nav-link ms-3 my-1" href="#use">使用大模型</a>
                    </nav>
                    <!-- <a class="nav-link" href="#item-3">Item 3</a>
                    <nav class="nav nav-pills flex-column">
                    <a class="nav-link ms-3 my-1" href="#item-3-1">Item 3-1</a>
                    <a class="nav-link ms-3 my-1" href="#item-3-2">Item 3-2</a>
                    </nav> -->
                </nav>
            </nav>
        </div>
    </div>
    </div>


    <!-- <div aria-live="polite" aria-atomic="true" class="position-fixed bd-example-toasts bottom-0 end-0 p-3"> -->
        <!-- <div class="toast-container p-3" id="menu_toast"> -->
            <!-- <div class="toast" id="menu_toast"> -->
            <!-- <div class="toast-header"> -->
                <!-- <img src="..." class="rounded me-2" alt="..."> -->
                <!-- <strong class="me-auto">Bootstrap</strong> -->
                <!-- <small>11 mins ago</small> -->
                <!-- <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> -->
            <!-- </div> -->
            <!-- <div class="toast-body"> -->
                <!-- Hello, world! This is a toast message. -->
                <!-- 在toast的body里面，放一个scrollspy目录 -->

            <!-- </div> -->
            <!-- </div> -->
        <!-- </div> -->
    <!-- </div> -->

    <script>
        const toastBtn = document.getElementById('liveToastBtn');
        toastBtn.addEventListener('click', () => {
            const toastEl = document.getElementById('liveToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        });

        // 一键复制
        document.querySelectorAll(".copy-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const code = btn.nextElementSibling.textContent;

            navigator.clipboard.writeText(code).then(() => {
            btn.innerHTML = '<i class="bi bi-check-lg"></i>';
            btn.classList.replace("btn-outline-secondary", "btn-success");

            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-copy"></i>';
                btn.classList.replace("btn-success", "btn-outline-secondary");
            }, 1200);
            });
        });
        });

    </script>

    <!-- icon图标，这个不知道为什么，放本地就报错 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="/static/js/bootstrap.bundle.5.2.3.min.js" crossorigin="anonymous"></script>
    <link href="/static/css/bootstrap_5.2.3.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="/static/js/popper.min.js" crossorigin="anonymous"></script>

  </body>
</html>